@using Data
@using DataAccessLibrary 

@inject EditedTwig EditedTwig
@inject TwigsHandler TwigsHandler
@inject TwigsTempStorage TwigsTempStorage  

<div class="card" style="float:right; width:30%">
    <h5 class="card-header">Edit</h5>
    <div class="card-body">
        @if (EditedTwig.Twig != null)
        {
            <div class="form-group">
                @if (EditedTwig.Twig.CompletedDate.HasValue)
                {
                    <div>Completed @EditedTwig.Twig.CompletedDate.Value.ToString()</div>
                }
            </div>
            <div class="form-group">
                <input @onfocusout="UpdateTwigInDatabase" @bind="EditedTwig.Twig.Title" @oninput="(e) => { EditedTwig.Twig.Title = (string)e.Value; EditedTwig.NestedTwig.Update(); }" class="form-control" />
            </div>
            <div class="form-group">
                <textarea @onfocusout="UpdateTwigInDatabase" @bind="EditedTwig.Twig.Description" @oninput="(e) => { EditedTwig.Twig.Description = (string)e.Value; EditedTwig.NestedTwig.Update(); }" class="form-control" rows="3" />
            </div>
            <div class="form-group">
                <input type="datetime-local" class="form-control" @onfocusout="() => TwigsHandler.UpdateTwigDueDate(EditedTwig.Twig)" @bind="EditedTwig.Twig.DueDate" @oninput="@((e) => { SetDueDate((string)e.Value); EditedTwig.NestedTwig.Update(); })" placeholder="Due Date" />
            </div>
            <div class="form-group">
                <input type="number" class="form-control" @onfocusout="() => UpdateTwigInDatabase()" @bind="EditedTwig.Twig.Priority" @oninput="@((e) => { SetPriority((string)e.Value); EditedTwig.NestedTwig.Update(); })" placeholder="Priority" />
            </div>
            <div id="state" class="form-group">
                <div class="form-check">
                    @if (EditedTwig.Twig.State == State.NOTSTARTED)
                    {
                        <input @onclick="() => SetState(State.NOTSTARTED)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" checked>
                    }
                    else
                    {
                        <input @onclick="() => SetState(State.NOTSTARTED)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1">
                    }
                    <label class="form-check-label" for="exampleRadios1">
                        Not started yet
                    </label>
                </div>
                <div class="form-check">
                    @if (EditedTwig.Twig.State == State.INPROGRESS)
                    {
                        <input @onclick="() => SetState(State.INPROGRESS)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2" checked>
                    }
                    else
                    {
                        <input @onclick="() => SetState(State.INPROGRESS)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2">
                    }
                    <label class="form-check-label" for="exampleRadios2">
                        In Progress
                    </label>
                </div>
                <div class="form-check">
                    @if (EditedTwig.Twig.State == State.COMPLETED)
                    {
                        <input @onclick="() => SetState(State.COMPLETED)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3" value="option3" checked>
                    }
                    else
                    {
                        <input @onclick="() => SetState(State.COMPLETED)" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3" value="option3">
                    }
                    <label class="form-check-label" for="exampleRadios3">
                        Completed
                    </label>
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-danger" @onclick="DeleteTwig">Remove</button>
            </div>
        }
        else
        {
            <div class="form-group">
                <input class="form-control" disabled />
            </div>
            <div class="form-group">
                <textarea class="form-control" rows="3" disabled />
            </div>
            <div class="form-group">
                <input type="datetime-local" class="form-control" placeholder="Due Date" disabled />
            </div>
            <div class="form-group">
                <input type="number" class="form-control" placeholder="Priority" disabled />
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" disabled>
                    <label class="form-check-label" for="exampleRadios1">
                        Not started yet
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2" disabled>
                    <label class="form-check-label" for="exampleRadios2">
                        In Progress
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3" value="option3" disabled>
                    <label class="form-check-label" for="exampleRadios3">
                        Completed
                    </label>
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-danger" disabled>Remove</button>
            </div>
        }
    </div>
</div>

@code {
    private void SetState(State state)
    {
        EditedTwig.Twig.State = state;

        if (state == State.COMPLETED)
        {
            EditedTwig.Twig.CompletedDate = DateTime.Now;
        }
        else
        {
            EditedTwig.Twig.CompletedDate = null;
        }

        Update();

        UpdateTwigInDatabase();
        TwigsHandler.UpdateTwigCompletedDate(EditedTwig.Twig);
    }

    private void SetDueDate(string dueDateText)
    {
        DateTime dueDate;
        bool success = DateTime.TryParse(dueDateText, out dueDate);

        if (success)
        {
            if (dueDate.Year > 1800 && dueDate.Year < 9000)
            {
                EditedTwig.Twig.DueDate = dueDate;
            }
        }
    }

    private void SetPriority(string priorityText)
    {
        int priority;
        bool success = Int32.TryParse(priorityText, out priority);

        if (success)
        {
            EditedTwig.Twig.Priority = priority;
        }
    }

    private void UpdateTwigInDatabase()
    {
        if (EditedTwig.Twig != null)
        {
            TwigsHandler.UpdateTwig(EditedTwig.Twig);
        }
    }

    private void DeleteTwig()
    {
        // deleting the twig record from the database
        TwigsHandler.RemoveTwig(EditedTwig.Twig.Id);

        // removing the twig from the GUI
        TwigsTempStorage.Twigs.Remove(EditedTwig.Twig);
        TwigsTempStorage.Order();

        // not displaing the twig anymore in the edit
        EditedTwig.Twig = null;
    }

    protected override void OnInitialized()
    {
        EditedTwig.Edit = this;
    }

    public void Update()
    {
        InvokeAsync(StateHasChanged);
    }
}
