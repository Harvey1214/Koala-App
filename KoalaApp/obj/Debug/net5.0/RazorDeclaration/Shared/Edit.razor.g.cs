// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace KoalaApp.Shared
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using KoalaApp;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\_Imports.razor"
using KoalaApp.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\Shared\Edit.razor"
using Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\Shared\Edit.razor"
using DataAccessLibrary;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\Shared\Edit.razor"
using System.Threading;

#line default
#line hidden
#nullable disable
    public partial class Edit : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 149 "C:\Users\mikuh\source\repos\KoalaApp\KoalaApp\Shared\Edit.razor"
       
    [Parameter]
    public bool Visible { get; set; } = true;

    private string visible
    {
        get
        {
            if (Visible) return "block";
            return "none";
        }
    }

    protected ElementReference Title;

    protected ElementReference Description;
    private string DescriptionWidth
    {
        get
        {
            if (TwigsTempStorage == null) return "";
            if (TwigsTempStorage.Tree == null) return "";
            if (TwigsTempStorage.Tree.Project == null) return "";
            if (TwigsTempStorage.Tree.Project.DescriptionFieldWidth == 0) return "";

            return $"height: {TwigsTempStorage.Tree.Project.DescriptionFieldWidth}px";
        }
    }

    private DateTime StartLoadTime { get; set; }
    private double Latency { get; set; }

    private double LatencyLimitForInstantUpdating { get; } = 50;

    private string DeleteButtonVisibility { get; set; } = displayBlock;
    private string ConfirmDeletionButtonVisiblity { get; set; } = displayNone;

    #region ReadonlyConstants
    private static readonly string displayBlock = "display: block;";
    private static readonly string displayNone = "display: none;";
    #endregion

    private void Copy()
    {
        TwigsTempStorage.CopiedTwig = EditedTwig.Twig.Copy();
    }

    private void Paste()
    {
        // check if there's a twig in the clipboard
        if (TwigsTempStorage.CopiedTwig == null)
        {
            return;
        }

        Twig twig = TwigsTempStorage.CopiedTwig.Copy();

        EditedTwig.Twig.Title = twig.Title;
        EditedTwig.Twig.Description = twig.Description;
        EditedTwig.Twig.Priority = twig.Priority;
        EditedTwig.Twig.State = twig.State;
        EditedTwig.Twig.DueDate = twig.DueDate;
        EditedTwig.Twig.CompletedDate = twig.CompletedDate;
        EditedTwig.Twig.ShowChildren = twig.ShowChildren;

        Update();
        EditedTwig.NestedTwig.Update();

        UpdateTwigInDatabase();
        TwigsHandler.UpdateTwigDueDate(EditedTwig.Twig);
        TwigsHandler.UpdateTwigCompletedDate(EditedTwig.Twig);
        TwigsHandler.UpdateTwigShowChildren(EditedTwig.Twig);

    }

    private void SetState(State state)
    {
        EditedTwig.Twig.State = state;

        if (state == State.COMPLETED)
        {
            EditedTwig.Twig.CompletedDate = DateTime.Now;
        }
        else
        {
            EditedTwig.Twig.CompletedDate = null;
        }

        Update();

        UpdateTwigInDatabase();
        TwigsHandler.UpdateTwigCompletedDate(EditedTwig.Twig);

        TwigsTempStorage.Order();
    }
    private void SetDueDate(string dueDateText)
    {
        DateTime dueDate;
        bool success = DateTime.TryParse(dueDateText, out dueDate);

        if (success)
        {
            if (dueDate.Year > 1800 && dueDate.Year < 9000)
            {
                EditedTwig.Twig.DueDate = dueDate;
            }
        }

        TwigsTempStorage.Order();
    }
    private void SetPriority(string priorityText)
    {
        int priority;
        bool success = Int32.TryParse(priorityText, out priority);

        if (success)
        {
            EditedTwig.Twig.Priority = priority;
        }

        TwigsTempStorage.Order();
    }

    private void UpdateTwigInDatabase()
    {
        if (EditedTwig.Twig != null)
        {
            TwigsHandler.UpdateTwig(EditedTwig.Twig);
        }
    }

    private void ShowConfirmDeletionDialog(bool show, bool delay = false)
    {
        if (delay) Thread.Sleep(500);

        if (show)
        {
            ConfirmDeletionButtonVisiblity = displayBlock;
            DeleteButtonVisibility = displayNone;
        }
        else
        {
            DeleteButtonVisibility = displayBlock;
            ConfirmDeletionButtonVisiblity = displayNone;
        }
    }
    private void DeleteTwig()
    {
        // deleting the twig record from the database
        TwigsHandler.RemoveTwig(EditedTwig.Twig.Id);

        // removing the twig from the GUI
        TwigsTempStorage.Twigs.Remove(EditedTwig.Twig);
        TwigsTempStorage.Order();

        // not displaing the twig anymore in the edit
        EditedTwig.Twig = null;

        ShowConfirmDeletionDialog(false);
    }

    private void UpdateEditedTwig()
    {
        if (EditedTwig.NestedTwig != null)
            EditedTwig.NestedTwig.Update();
        else
        {
            TwigsTempStorage.NestedStructure.UpdateAll();
        }

        TwigsTempStorage.UpdateSearchSort();
    }

    protected override void OnInitialized()
    {
        StartLoadTime = DateTime.Now;
        EditedTwig.Edit = this;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            Latency = (DateTime.Now - StartLoadTime).TotalMilliseconds;
            InvokeAsync(StateHasChanged);
        }
    }

    public void MobileOpenForEdittingCheck()
    {
        if (WindowDimensions.Mobile)
        {
            Visible = true;
        }
    }
    private void Close()
    {
        Visible = false;
    }

    public void Update()
    {
        ShowConfirmDeletionDialog(false);
        InvokeAsync(StateHasChanged);
    }

    public void FocusOnTitle()
    {
        if (Title.Equals(null) == false) Title.FocusAsync();
    }

    private async void SaveDescriptionWidth()
    {
        if (Description.Equals(null) || TwigsTempStorage.Tree == null) return;

        BoundingClientRect rect = await GetElementRect(Description);
        TwigsTempStorage.Tree.Project.DescriptionFieldWidth = (int)rect.Height;

        ProjectsHandler.UpdateProjectDescriptionFieldWidth(TwigsTempStorage.Tree.Project);
    }

    public async Task<BoundingClientRect> GetElementRect(ElementReference elementReference)
    {
        return await JS.InvokeAsync<BoundingClientRect>("MyDOMGetBoundingClientRect", elementReference);
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JS { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ProjectsHandler ProjectsHandler { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private WindowDimensions WindowDimensions { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TwigsTempStorage TwigsTempStorage { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TwigsHandler TwigsHandler { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private EditedTwig EditedTwig { get; set; }
    }
}
#pragma warning restore 1591
